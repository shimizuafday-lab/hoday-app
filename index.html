<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>放課後等デイサービス・ガイド</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React本体 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (JSX変換) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                school: <path d="M12 22v-9M2 7l10-5 10 5v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7zM7 22V7M17 22V7" />,
                search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
                refresh: <><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 16h5v5" /></>,
                mapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></>,
                phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />,
                x: <path d="M18 6 6 18M6 6l12 12" />
            };
            const content = icons[name] || icons.school;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {content}
                </svg>
            );
        };

        const App = () => {
            // 更新されたCSV URL
            const SPREADSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-3HsrNideEQfqOrC604NY0NkwaQ7sxjMog2vuwVymliZN6XMsE58_wA-rErOJMMHP9Y49BIUiLDq1/pub?output=csv";

            const [facilities, setFacilities] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedFacility, setSelectedFacility] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const fetchCSVData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(SPREADSHEET_CSV_URL);
                    if (!response.ok) throw new Error(`HTTPエラー: ${response.status}`);
                    
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('CSVデータが空、またはヘッダーのみです。');
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    
                    const data = lines.slice(1).map((line) => {
                        const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        const obj = {};
                        headers.forEach((header, i) => {
                            let val = values[i]?.replace(/^"|"$/g, '').replace(/""/g, '"').trim() || "";
                            val = val.replace(/<[^>]*>?/gm, '');
                            obj[header] = val;
                        });
                        return obj;
                    });
                    
                    setFacilities(data);
                    setError(null);
                } catch (err) {
                    console.error("Fetch error:", err);
                    setError(`データの読み込みに失敗しました。URLが正しいか、スプレッドシートの「ウェブに公開（CSV形式）」設定が有効か確認してください。`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchCSVData();
            }, []);

            const filteredFacilities = facilities.filter(f => 
                (f['事業所名']?.toLowerCase().includes(searchTerm.toLowerCase())) || 
                (f['住所']?.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-blue-600 text-white p-6 shadow-md sticky top-0 z-10">
                        <div className="max-w-4xl mx-auto">
                            <h1 className="text-2xl font-bold mb-4 flex items-center gap-2">
                                <Icon name="school" size={28} /> 放デイ・ガイド
                            </h1>
                            <div className="relative">
                                <Icon name="search" size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                <input
                                    type="text"
                                    placeholder="事業所名や住所で検索..."
                                    className="w-full pl-10 pr-4 py-3 rounded-xl text-gray-900 focus:outline-none shadow-inner"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 mt-4">
                        {loading ? (
                            <div className="text-center py-20 text-gray-400 font-bold italic">
                                <Icon name="refresh" size={40} className="animate-spin mx-auto mb-4" />
                                <p>読み込み中...</p>
                            </div>
                        ) : error ? (
                            <div className="bg-red-50 text-red-700 p-8 rounded-2xl border border-red-200">
                                <p className="font-bold mb-2">エラーが発生しました：</p>
                                <p className="text-sm opacity-80">{error}</p>
                                <button onClick={fetchCSVData} className="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-bold">再試行する</button>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {filteredFacilities.map((facility, index) => (
                                    <div 
                                        key={index} 
                                        className="bg-white rounded-2xl shadow-sm hover:shadow-md transition-all overflow-hidden cursor-pointer border border-gray-100 flex flex-col h-full"
                                        onClick={() => setSelectedFacility(facility)}
                                    >
                                        <div className="relative h-48 w-full bg-gray-200">
                                            <img 
                                                src={facility.pic1 || 'https://images.unsplash.com/photo-1594608661623-aa0bd3a69d98?w=400'} 
                                                className="h-full w-full object-cover"
                                                alt={facility['事業所名']}
                                                loading="lazy"
                                                onError={(e) => { e.target.src = 'https://images.unsplash.com/photo-1594608661623-aa0bd3a69d98?w=400'; }}
                                            />
                                        </div>
                                        <div className="p-5 flex-grow flex flex-col">
                                            <h2 className="text-lg font-bold mb-2">{facility['事業所名']}</h2>
                                            <p className="text-gray-500 text-xs mb-4 flex items-center gap-1">
                                                <Icon name="mapPin" size={14} /> {facility['住所']}
                                            </p>
                                            <div className="mt-auto py-2 bg-blue-50 text-blue-600 rounded-lg text-center font-bold text-sm">詳細を見る</div>
                                        </div>
                                    </div>
                                ))}
                                {filteredFacilities.length === 0 && (
                                    <div className="col-span-full text-center py-10 text-gray-500">該当する事業所が見つかりませんでした。</div>
                                )}
                            </div>
                        )}
                    </main>

                    {selectedFacility && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4" onClick={() => setSelectedFacility(null)}>
                            <div className="bg-white w-full max-w-2xl max-h-[90vh] rounded-t-3xl sm:rounded-3xl overflow-y-auto p-6 relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setSelectedFacility(null)} className="absolute top-4 right-4 p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                                    <Icon name="x" size={24} />
                                </button>
                                <h2 className="text-2xl font-bold mb-6 pr-8">{selectedFacility['事業所名']}</h2>
                                <div className="space-y-6">
                                    <div className="bg-gray-50 p-4 rounded-xl">
                                        <p className="text-xs font-bold text-gray-400 mb-1">住所</p>
                                        <p className="font-bold text-sm">{selectedFacility['住所']}</p>
                                        <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(selectedFacility['住所'])}`, '_blank')} className="mt-2 text-blue-600 font-bold flex items-center gap-1 underline text-sm">
                                            Googleマップで開く
                                        </button>
                                    </div>
                                    {selectedFacility['アピールポイント'] && (
                                        <div className="bg-blue-50 p-6 rounded-2xl italic text-gray-700 leading-relaxed">
                                            "{selectedFacility['アピールポイント']}"
                                        </div>
                                    )}
                                    <a href={`tel:${selectedFacility['電話番号']}`} className="flex items-center justify-center gap-2 w-full bg-blue-600 text-white text-center py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition-colors">
                                        <Icon name="phone" size={20} /> 電話で問い合わせ：{selectedFacility['電話番号']}
                                    </a>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
