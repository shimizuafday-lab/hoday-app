<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>放デイ・ガイド（画像安定版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        .img-loading { background: #f3f4f6; position: relative; }
        .img-loading::after { content: "Loading..."; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 12px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const SPREADSHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-3HsrNideEQfqOrC604NY0NkwaQ7sxjMog2vuwVymliZN6XMsE58_wA-rErOJMMHP9Y49BIUiLDq1/pub?output=csv";
            const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1594608661623-aa0bd3a69d98?w=800';
            
            const [facilities, setFacilities] = useState([]);
            const [loading, setLoading] = useState(true);

            // 【超重要】Googleドライブのリンクを「表示用」に強制変換するロジック
            const getValidImageUrl = (url) => {
                if (!url || typeof url !== 'string') return DEFAULT_IMAGE;
                const trimmedUrl = url.trim();
                
                // Google Drive 共有リンクの判定
                if (trimmedUrl.includes('drive.google.com')) {
                    let fileId = '';
                    // パターン1: /d/xxxx/view
                    if (trimmedUrl.includes('/d/')) {
                        fileId = trimmedUrl.split('/d/')[1].split('/')[0];
                    } 
                    // パターン2: id=xxxx
                    else if (trimmedUrl.includes('id=')) {
                        fileId = trimmedUrl.split('id=')[1].split('&')[0];
                    }
                    
                    if (fileId) {
                        // thumbnail 形式の方が高速でブロックされにくい
                        return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                    }
                }
                return trimmedUrl;
            };

            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim() : '');
                    return obj;
                }).filter(f => f['事業所名']);
            };

            useEffect(() => {
                fetch(SPREADSHEET_CSV_URL)
                    .then(res => res.text())
                    .then(text => {
                        setFacilities(parseCSV(text));
                        setLoading(false);
                    })
                    .catch(err => {
                        console.error(err);
                        setLoading(false);
                    });
            }, []);

            return (
                <div className="p-4 max-w-4xl mx-auto">
                    <h1 className="text-2xl font-bold mb-6">事業所リスト</h1>
                    {loading ? (
                        <p>読み込み中...</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {facilities.map((f, i) => (
                                <div key={i} className="bg-white rounded-xl shadow overflow-hidden border">
                                    <div className="h-48 overflow-hidden bg-gray-100 relative">
                                        <img 
                                            src={getValidImageUrl(f.pic1)} 
                                            className="w-full h-full object-cover"
                                            onError={(e) => {
                                                console.log("Image Load Error:", e.target.src);
                                                e.target.src = DEFAULT_IMAGE;
                                            }}
                                        />
                                    </div>
                                    <div className="p-4">
                                        <h2 className="font-bold text-lg">{f['事業所名']}</h2>
                                        <p className="text-sm text-gray-500">{f['住所']}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
